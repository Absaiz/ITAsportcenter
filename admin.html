<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ITA | ADMIN PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script>
        const v = Date.now();
        function cargar(src) {
            const s = document.createElement('script');
            s.type = 'module'; s.src = src + '?v=' + v;
            document.head.appendChild(s);
        }
        cargar('layout.js');
        cargar('user-logic.js');
    </script>

    <style>
        /* ESTILOS DEL PANEL ADMIN AVANZADO */
        .admin-layout { max-width: 1200px; margin: 40px auto; padding: 20px; display: grid; gap: 40px; }
        .panel-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 25px; }
        .panel-title { font-family: 'Oswald'; color: var(--accent-pink); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* TABLA DE USUARIOS */
        .user-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .user-table th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #444; }
        .user-table td { padding: 15px 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        .user-table tr:hover { background: #222; }
        
        .credit-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; margin-bottom: 5px; background: #333; border: 1px solid #444; }
        .tag-fuerza { color: #ff9f43; border-color: #ff9f43; }
        .tag-pilates { color: #54a0ff; border-color: #54a0ff; }
        .tag-personal { color: #ff6b6b; border-color: #ff6b6b; }
        .tag-nutri { color: #1dd1a1; border-color: #1dd1a1; }

        .btn-mini { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; background: #444; color: white; transition: 0.3s; }
        .btn-mini:hover { background: var(--accent-pink); }
        .btn-edit { background: #2e86de; }
        .btn-delete { background: #ff4444; color: white; margin-left: 5px; }
        .btn-kick { background: transparent; border: 1px solid #ff4444; color: #ff4444; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 10px; }
        .btn-kick:hover { background: #ff4444; color: white; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 30px; border-radius: 10px; border: 1px solid var(--accent-pink); width: 90%; max-width: 500px; }
        .credit-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .btn-circle { width: 30px; height: 30px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; }
        .btn-minus { background: #444; color: white; }
        .btn-plus { background: #25D366; color: black; }
        
        /* FORMULARIO Y CALENDARIO */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn-create { width: 100%; padding: 12px; background: var(--accent-pink); color: white; border: none; font-weight: bold; cursor: pointer; }

        .calendar-day { margin-bottom: 20px; }
        .day-header { background: #333; color: white; padding: 10px; font-weight: bold; border-radius: 5px; margin-bottom: 10px; }
        .class-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-left: 4px solid #555; margin-bottom: 5px; border-radius: 4px; }
        .class-item.type-fuerza { border-color: #ff9f43; }
        .class-item.type-pilates { border-color: #54a0ff; }
        
        .attendees-list { display: none; background: #111; padding: 10px; font-size: 0.9rem; color: #ccc; margin-bottom: 15px; border: 1px dashed #444; }
        .attendee-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div class="admin-layout">
        <h1 style="text-align: center; font-size: 3rem; margin: 0;">ADMINISTRACI√ìN</h1>

        <div class="panel-card">
            <div class="panel-title">üìÖ NUEVA CLASE</div>
            <div class="form-grid">
                <input type="text" id="nombreClase" placeholder="Nombre (Ej: Pilates Avanzado)">
                <select id="tipoClase">
                    <option value="fuerza">Fuerza</option>
                    <option value="pilates">Pilates</option>
                    <option value="personal">Entreno Personal</option>
                    <option value="nutricion">Nutrici√≥n</option>
                </select>
                <input type="date" id="fechaClase">
                <input type="time" id="horaClase">
                <input type="number" id="plazasClase" placeholder="Plazas Max" value="6">
            </div>
            <button class="btn-create" onclick="crearClase()">PROGRAMAR CLASE</button>
        </div>

        <div class="panel-card">
            <div class="panel-title">
                <span>üóìÔ∏è CALENDARIO</span>
                <button class="btn-mini" onclick="cargarCalendario()">üîÑ Refrescar</button>
            </div>
            <div id="calendarioContainer">
                <p style="text-align: center; color: #666;">Cargando clases...</p>
            </div>
        </div>

        <div class="panel-card">
            <div class="panel-title">
                <span>üë• TODOS LOS USUARIOS</span>
                <button class="btn-mini" onclick="cargarUsuarios()">üîÑ Refrescar</button>
            </div>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Saldos</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="modalCreditos" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalUserNombre" style="margin-top:0;">Editar Saldos</h3>
            <p id="modalUserEmail" style="color:#888; margin-bottom:20px;">...</p>
            <div id="creditEditors"></div>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModal()">CERRAR</button>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, addDoc, doc, updateDoc, deleteDoc, getDoc, query, orderBy, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        let allUsers = [];

        // --- 1. CARGAR USUARIOS ---
        window.cargarUsuarios = async () => {
            const tbody = document.getElementById('tablaUsuarios');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Cargando...</td></tr>';
            try {
                const querySnapshot = await getDocs(collection(db, "usuarios"));
                allUsers = [];
                let html = "";
                querySnapshot.forEach((docSnap) => {
                    const u = docSnap.data();
                    u.id = docSnap.id;
                    allUsers.push(u);
                    const creds = u.creditos_detalle || {};
                    // L√≥gica para compatibilidad con saldos viejos
                    if (typeof u.creditos === 'number' && creds.fuerza === undefined) creds.fuerza = u.creditos;

                    html += `
                        <tr>
                            <td>
                                <div style="font-weight:bold; color:white;">${u.nombre || 'Sin Nombre'}</div>
                                <div style="font-size:0.8rem; color:#666;">${u.email}</div>
                            </td>
                            <td>
                                <span class="credit-tag tag-fuerza">F: ${creds.fuerza||0}</span>
                                <span class="credit-tag tag-pilates">P: ${creds.pilates||0}</span>
                                <span class="credit-tag tag-personal">EP: ${creds.personal||0}</span>
                                <span class="credit-tag tag-nutri">N: ${creds.nutri||0}</span>
                            </td>
                            <td>
                                <button class="btn-mini btn-edit" onclick="abrirModal('${u.id}')">EDITAR</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            } catch (e) { console.error(e); }
        };

        // --- 2. MODAL Y CR√âDITOS ---
        window.abrirModal = (uid) => {
            const user = allUsers.find(u => u.id === uid);
            if(!user) return;
            document.getElementById('modalUserNombre').innerText = user.nombre || 'Usuario';
            document.getElementById('modalUserEmail').innerText = user.email;
            
            const container = document.getElementById('creditEditors');
            container.innerHTML = "";
            const tipos = [
                { id: 'fuerza', label: 'FUERZA', color: '#ff9f43' },
                { id: 'pilates', label: 'PILATES', color: '#54a0ff' },
                { id: 'personal', label: 'PERSONAL', color: '#ff6b6b' },
                { id: 'nutri', label: 'NUTRICI√ìN', color: '#1dd1a1' }
            ];

            let creds = user.creditos_detalle || {};
            if (typeof user.creditos === 'number' && creds.fuerza === undefined) creds.fuerza = user.creditos;

            tipos.forEach(t => {
                const val = creds[t.id] || 0;
                container.innerHTML += `
                    <div class="credit-row">
                        <strong style="color:${t.color}">${t.label}</strong>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <button class="btn-circle btn-minus" onclick="cambiarSaldo('${uid}', '${t.id}', -1)">-</button>
                            <span style="font-size:1.2rem; font-weight:bold; width:30px; text-align:center;">${val}</span>
                            <button class="btn-circle btn-plus" onclick="cambiarSaldo('${uid}', '${t.id}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('modalCreditos').style.display = 'flex';
        }

        window.cerrarModal = () => document.getElementById('modalCreditos').style.display = 'none';

        window.cambiarSaldo = async (uid, tipo, cantidad) => {
            try {
                const userRef = doc(db, "usuarios", uid);
                const userSnap = await getDoc(userRef);
                let newCreds = userSnap.data().creditos_detalle || {};
                
                // Inicializar si no existe
                if (typeof userSnap.data().creditos === 'number' && newCreds.fuerza === undefined) {
                    newCreds.fuerza = userSnap.data().creditos;
                }

                const actual = newCreds[tipo] || 0;
                newCreds[tipo] = actual + cantidad;
                if(newCreds[tipo] < 0) newCreds[tipo] = 0;

                await updateDoc(userRef, {
                    creditos_detalle: newCreds,
                    creditos: newCreds.fuerza // Sincronizar legacy
                });
                await cargarUsuarios();
                abrirModal(uid);
            } catch (e) { alert("Error: " + e.message); }
        }

        // --- 3. CREAR Y BORRAR CLASE ---
        window.crearClase = async () => {
            const nombre = document.getElementById('nombreClase').value;
            const tipo = document.getElementById('tipoClase').value;
            const fecha = document.getElementById('fechaClase').value;
            const hora = document.getElementById('horaClase').value;
            const plazas = parseInt(document.getElementById('plazasClase').value);

            if(!nombre || !fecha || !hora) { alert("Rellena todo"); return; }

            try {
                await addDoc(collection(db, "clases"), {
                    nombre, tipo, fecha, hora, plazas_totales: plazas,
                    apuntados: [],
                    timestamp: new Date(fecha + 'T' + hora)
                });
                alert("Clase creada");
                cargarCalendario();
            } catch(e) { alert("Error: " + e.message); }
        }

        window.eliminarClase = async (id) => {
            if(!confirm("¬øSeguro que quieres borrar esta clase? Se borrar√° para siempre.")) return;
            try {
                await deleteDoc(doc(db, "clases", id));
                cargarCalendario();
            } catch(e) { alert("Error al borrar: " + e.message); }
        }

        // --- 4. CALENDARIO Y EXPULSAR ---
        window.cargarCalendario = async () => {
            const container = document.getElementById('calendarioContainer');
            container.innerHTML = "Cargando...";
            try {
                const q = query(collection(db, "clases"), orderBy("timestamp", "asc"));
                const snap = await getDocs(q);
                if(snap.empty) { container.innerHTML = "No hay clases."; return; }

                const grupos = {};
                snap.forEach(d => {
                    const data = d.data(); data.id = d.id;
                    if(!grupos[data.fecha]) grupos[data.fecha] = [];
                    grupos[data.fecha].push(data);
                });

                let html = "";
                Object.keys(grupos).sort().forEach(fecha => {
                    html += `<div class="calendar-day"><div class="day-header">${fecha}</div>`;
                    grupos[fecha].forEach(c => {
                        const libres = c.plazas_totales - (c.apuntados ? c.apuntados.length : 0);
                        html += `
                            <div class="class-item type-${c.tipo}">
                                <div>
                                    <strong>${c.hora} - ${c.nombre}</strong><br>
                                    <span style="font-size:0.8rem; opacity:0.7">${c.tipo.toUpperCase()} ‚Ä¢ Libres: ${libres}/${c.plazas_totales}</span>
                                </div>
                                <div>
                                    <button class="btn-mini" onclick="verAsistentes('${c.id}', '${c.tipo}')">üë• Ver Usuarios</button>
                                    <button class="btn-mini btn-delete" onclick="eliminarClase('${c.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div id="asistentes-${c.id}" class="attendees-list"></div>
                        `;
                    });
                    html += `</div>`;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        window.verAsistentes = async (claseId, tipoClase) => {
            const div = document.getElementById(`asistentes-${claseId}`);
            if(div.style.display === 'block') { div.style.display = 'none'; return; }
            
            div.style.display = 'block';
            div.innerHTML = "Cargando...";

            try {
                const claseRef = doc(db, "clases", claseId);
                const claseSnap = await getDoc(claseRef);
                const ids = claseSnap.data().apuntados || [];

                if(ids.length === 0) { div.innerHTML = "Nadie apuntado."; return; }

                let html = "";
                for(const uid of ids) {
                    const uSnap = await getDoc(doc(db, "usuarios", uid));
                    const nombre = uSnap.exists() ? uSnap.data().nombre : "Desconocido";
                    const email = uSnap.exists() ? uSnap.data().email : "---";
                    
                    html += `
                        <div class="attendee-row">
                            <span>${nombre} <small>(${email})</small></span>
                            <button class="btn-kick" title="Expulsar y Devolver Cr√©dito" 
                                onclick="expulsarUsuario('${claseId}', '${uid}', '${tipoClase}')">‚ùå</button>
                        </div>
                    `;
                }
                div.innerHTML = html;
            } catch(e) { div.innerHTML = "Error: " + e.message; }
        }

        window.expulsarUsuario = async (claseId, userId, tipoClase) => {
            if(!confirm("¬øQuitar usuario de la clase y devolverle el cr√©dito?")) return;
            
            try {
                // 1. Quitar de la clase
                const claseRef = doc(db, "clases", claseId);
                await updateDoc(claseRef, {
                    apuntados: arrayRemove(userId)
                });

                // 2. Devolver Cr√©dito (Seg√∫n el tipo de clase)
                const userRef = doc(db, "usuarios", userId);
                const userSnap = await getDoc(userRef);
                
                // Necesitamos la ruta exacta del cr√©dito (ej: creditos_detalle.pilates)
                // Firestore no deja usar variables din√°micas en claves anidadas f√°cilmente con 'increment' directo en updateDoc simple
                // As√≠ que leemos, sumamos y guardamos.
                let data = userSnap.data();
                let creds = data.creditos_detalle || {};
                
                // Fallback para antiguos
                if (typeof data.creditos === 'number' && creds.fuerza === undefined) creds.fuerza = data.creditos;

                if (!creds[tipoClase]) creds[tipoClase] = 0;
                creds[tipoClase] += 1;

                await updateDoc(userRef, {
                    creditos_detalle: creds,
                    creditos: creds.fuerza // Sincronizar legacy
                });

                alert("Usuario expulsado y cr√©dito devuelto.");
                verAsistentes(claseId, tipoClase); // Refrescar lista visual
                cargarCalendario(); // Refrescar contadores de plazas

            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        window.onload = () => { cargarUsuarios(); cargarCalendario(); };
    </script>
</body>
</html>