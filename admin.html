<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ITA | ADMIN PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script>
        const v = Date.now();
        function cargarCSS(a) { var l = document.createElement("link"); l.rel = "stylesheet"; l.href = a + "?v=" + v; document.head.appendChild(l); }
        function cargarJS(a) { var s = document.createElement('script'); s.type = 'module'; s.src = a + "?v=" + v; document.head.appendChild(s); }
        cargarCSS('style.css'); cargarJS('layout.js'); cargarJS('user-logic.js');
    </script>

    <style>
        body { background-color: #121212; color: white; font-family: 'Montserrat', sans-serif; }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        
        /* TABS */
        .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { background: #222; color: #888; border: 1px solid #333; padding: 10px 25px; cursor: pointer; border-radius: 30px; font-family: 'Oswald'; text-transform: uppercase; transition: 0.3s; }
        .tab-btn.active { background: #ff007f; color: white; border-color: #ff007f; box-shadow: 0 0 10px rgba(255,0,127,0.3); }

        .view-section { display: none; grid-template-columns: 1fr; gap: 30px; }
        .view-section.active { display: grid; }

        /* PANELES */
        .panel-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 20px; }
        .panel-title { font-family: 'Oswald'; color: #ff007f; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* HEATMAP */
        .heat-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem; }
        .heat-table th { color: #ff007f; padding: 8px; border-bottom: 1px solid #444; font-family: 'Oswald'; }
        .heat-table td { padding: 8px; border: 1px solid #333; color: #555; cursor: pointer; transition: 0.2s; }
        .heat-table td:hover { border: 1px solid white; }
        
        .h-low { background: rgba(255, 0, 127, 0.1); color: white !important; font-weight: bold; }
        .h-med { background: rgba(255, 0, 127, 0.4); color: white !important; font-weight: bold; }
        .h-high { background: rgba(255, 0, 127, 0.8); color: white !important; font-weight: bold; }

        /* TABLAS SOCIOS */
        .user-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .user-table th, .user-table td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        .btn-mini { padding: 5px 10px; border-radius: 4px; background: #444; color: white; border: none; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
        .btn-mini:hover { background: #ff007f; }
        .btn-del { background: transparent; border: 1px solid #ff4444; color: #ff4444; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        
        /* FORMULARIO */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; }
        .btn-create { width: 100%; padding: 10px; background: #ff007f; border: none; color: white; font-weight: bold; cursor: pointer; }
        
        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border: 1px solid #ff007f; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        /* CALENDARIO SOCIO (MODAL) */
        .socio-calendar-table { width: 100%; text-align: center; font-size: 0.8rem; }
        .socio-calendar-table th { color: #ff007f; font-family:'Oswald'; }
        .socio-calendar-table td { padding: 4px; border: 1px solid #333; }
        .cell-selected { background-color: #ff007f; color: white; }
        
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-pending { background: #444; color: #aaa; }
        .badge-confirmed { background: #25D366; color: black; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1 style="text-align: center; margin-bottom: 30px;">ADMIN PANEL</h1>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="cambiarPestana('demanda')">üìä MAPA CALOR</button>
            <button class="tab-btn" onclick="cambiarPestana('clases')">üìÖ CLASES</button>
            <button class="tab-btn" onclick="cambiarPestana('socios')">üë• SOCIOS</button>
        </div>

        <div id="vista-demanda" class="view-section active">
            <div class="panel-card" style="border-color: #ff007f;">
                <div class="panel-title">
                    <span>üî• PREFERENCIAS (Haz clic en un n¬∫ para ver qui√©nes son)</span>
                    <button class="btn-mini" onclick="cargarTodo()">Actualizar</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="heat-table">
                        <thead>
                            <tr><th>HORA</th><th>LUN</th><th>MAR</th><th>MI√â</th><th>JUE</th><th>VIE</th><th>S√ÅB</th></tr>
                        </thead>
                        <tbody id="tablaCalor">
                            <tr><td colspan="7">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vista-clases" class="view-section">
            <div class="panel-card">
                <div class="panel-title">NUEVA CLASE</div>
                <div class="form-grid">
                    <input type="text" id="nombreClase" placeholder="Nombre">
                    <select id="tipoClase"><option value="fuerza">Fuerza</option><option value="pilates">Pilates</option></select>
                    <input type="date" id="fechaClase">
                    <input type="time" id="horaClase">
                    <input type="number" id="plazasClase" value="6">
                </div>
                <button class="btn-create" onclick="crearClase()">CREAR CLASE</button>
            </div>
            <div class="panel-card">
                <div class="panel-title">CALENDARIO <button class="btn-mini" onclick="cargarCalendario()">Refrescar</button></div>
                <div id="calendarioContainer">Cargando...</div>
            </div>
        </div>

        <div id="vista-socios" class="view-section">
            <div class="panel-card">
                <div class="panel-title">LISTA DE SOCIOS <button class="btn-mini" onclick="cargarTodo()">Refrescar</button></div>
                <table class="user-table">
                    <thead><tr><th>Usuario</th><th>Estado Horario</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="tablaUsuarios"></tbody>
                </table>
            </div>
            <div class="panel-card mt-4">
                <div class="panel-title">LEADS (WEB) <button class="btn-mini" onclick="cargarInteresados()">Refrescar</button></div>
                <table class="user-table">
                    <tbody id="tablaLeads"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalCreditos" class="modal-overlay">
        <div class="modal-content" style="max-width:400px;">
            <h3 id="modalUserNombre">Usuario</h3>
            <div id="creditEditors"></div>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModales()">CERRAR</button>
        </div>
    </div>

    <div id="modalQuien" class="modal-overlay">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <h3 style="color:#ff007f; font-family:'Oswald';">INTERESADOS</h3>
            <h5 id="modalQuienTitulo" style="color:#aaa; margin-bottom:20px;"></h5>
            <ul id="listaInteresados" style="list-style:none; padding:0; text-align:left; border:1px solid #333; padding:10px; background:#222;"></ul>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModales()">CERRAR</button>
        </div>
    </div>

    <div id="modalCalendarioSocio" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="calSocioNombre" style="color:white; font-family:'Oswald'; margin:0;"></h3>
                <span id="calSocioStatus"></span>
            </div>
            <p style="color:#aaa; font-size:0.9rem;">Preferencias marcadas por el usuario:</p>
            
            <div style="max-height:400px; overflow-y:auto; margin-bottom:20px;">
                <table class="socio-calendar-table">
                    <thead><tr><th>H</th><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th></tr></thead>
                    <tbody id="calSocioBody"></tbody>
                </table>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-create" style="background:#444;" onclick="cerrarModales()">CERRAR</button>
                <button id="btnConfirmarHorario" class="btn-create" style="background:#25D366; color:black;">‚úÖ CONFIRMAR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        let allUsersGlobal = []; // Para tener los datos siempre a mano

        // --- SISTEMA DE PESTA√ëAS ---
        window.cambiarPestana = (p) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`vista-${p}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(p==='demanda') btns[0].classList.add('active');
            if(p==='clases') btns[1].classList.add('active');
            if(p==='socios') btns[2].classList.add('active');
        }

        // --- CARGA DE DATOS GENERAL ---
        window.cargarTodo = async () => {
            await cargarUsuarios(); // Esto llena allUsersGlobal
            cargarMapaCalor();      // Esto usa allUsersGlobal
            cargarCalendario();
            cargarInteresados();
        }

        // --- 1. USUARIOS Y SOCIOS ---
        window.cargarUsuarios = async () => {
            const tbody = document.getElementById('tablaUsuarios');
            if(tbody) tbody.innerHTML = '<tr><td>Cargando...</td></tr>';
            
            try {
                const snap = await getDocs(collection(db, "usuarios"));
                allUsersGlobal = [];
                let html = "";
                snap.forEach(d => {
                    const u = d.data(); u.id = d.id; allUsersGlobal.push(u);
                    const c = u.creditos_detalle || {};
                    if(typeof u.creditos === 'number' && !c.fuerza) c.fuerza = u.creditos;
                    
                    // Estado del horario
                    let estadoHtml = `<span class="status-badge badge-pending">Pendiente</span>`;
                    if(u.horario_confirmado) estadoHtml = `<span class="status-badge badge-confirmed">Confirmado</span>`;

                    html += `<tr>
                        <td><strong>${u.nombre||'Socio'}</strong><br><small style="color:#888">${u.email}</small></td>
                        <td>${estadoHtml}</td>
                        <td>
                            <button class="btn-mini" onclick="abrirModalCreditos('${u.id}')">üí∞</button>
                            <button class="btn-mini" style="background:#54a0ff;" onclick="verCalendarioSocio('${u.id}')">üìÖ</button>
                            <button class="btn-del" onclick="borrarUsuario('${u.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                if(tbody) tbody.innerHTML = html;
            } catch(e) { console.error(e); }
        };

        // --- 2. MAPA DE CALOR INTERACTIVO ---
        window.cargarMapaCalor = () => {
            // Usamos allUsersGlobal que ya carg√≥ en cargarUsuarios
            const tbody = document.getElementById('tablaCalor');
            if(!tbody) return;
            
            // Matriz: Clave = "Dia-Hora" (ej: "L-18") -> Array de nombres
            let heatMap = {}; 
            const dias = ['L', 'Ma', 'X', 'J', 'V', 'S'];
            for(let h=7; h<=22; h++) { dias.forEach(d => { heatMap[`${d}-${h}`] = []; }); }

            // Llenar con nombres
            allUsersGlobal.forEach(u => {
                if(u.preferencias_horario && Array.isArray(u.preferencias_horario)) {
                    u.preferencias_horario.forEach(voto => {
                        if(heatMap[voto] !== undefined) heatMap[voto].push(u.nombre || u.email);
                    });
                }
            });

            // Pintar HTML
            let html = "";
            for(let h=7; h<=22; h++) {
                let horaStr = h < 10 ? `0${h}:00` : `${h}:00`;
                html += `<tr><td style="color:#ff007f; font-weight:bold;">${horaStr}</td>`;
                
                dias.forEach(d => {
                    const lista = heatMap[`${d}-${h}`];
                    const val = lista.length;
                    let clase = "";
                    let clickFn = "";
                    
                    if(val > 0) {
                        if(val <= 3) clase = "h-low";
                        else if(val <= 7) clase = "h-med";
                        else clase = "h-high";
                        
                        // Aqu√≠ guardamos los nombres en el atributo data para no complicar el string
                        const nombresSafe = JSON.stringify(lista).replace(/"/g, '&quot;');
                        clickFn = `onclick="verQuien('${d}', ${h}, ${nombresSafe})"`;
                    }
                    
                    html += `<td class="${clase}" ${clickFn}>${val > 0 ? val : '-'}</td>`;
                });
                html += `</tr>`;
            }
            tbody.innerHTML = html;
        };

        // --- 3. MODAL: QUI√âN QUIERE ESTA HORA ---
        window.verQuien = (dia, hora, listaNombres) => {
            const diasFull = {'L':'Lunes', 'Ma':'Martes', 'X':'Mi√©rcoles', 'J':'Jueves', 'V':'Viernes', 'S':'S√°bado'};
            document.getElementById('modalQuienTitulo').innerText = `${diasFull[dia]} a las ${hora}:00`;
            const ul = document.getElementById('listaInteresados');
            ul.innerHTML = "";
            listaNombres.forEach(nom => {
                ul.innerHTML += `<li style="padding:5px; border-bottom:1px solid #444;">üë§ ${nom}</li>`;
            });
            document.getElementById('modalQuien').style.display = 'flex';
        }

        // --- 4. MODAL: CALENDARIO SOCIO (CONFIRMACI√ìN) ---
        window.verCalendarioSocio = (uid) => {
            const u = allUsersGlobal.find(x => x.id === uid);
            if(!u) return;

            document.getElementById('calSocioNombre').innerText = u.nombre || "Socio";
            const statusSpan = document.getElementById('calSocioStatus');
            
            if(u.horario_confirmado) {
                statusSpan.innerHTML = '<span class="status-badge badge-confirmed">CONFIRMADO</span>';
                document.getElementById('btnConfirmarHorario').style.display = 'none';
            } else {
                statusSpan.innerHTML = '<span class="status-badge badge-pending">PENDIENTE</span>';
                document.getElementById('btnConfirmarHorario').style.display = 'block';
                document.getElementById('btnConfirmarHorario').onclick = () => confirmarHorario(uid);
            }

            // Pintar tabla miniatura
            const tbody = document.getElementById('calSocioBody');
            const dias = ['L', 'Ma', 'X', 'J', 'V', 'S'];
            const prefs = u.preferencias_horario || [];
            let html = "";

            for(let h=7; h<=22; h++) {
                html += `<tr><td>${h}</td>`;
                dias.forEach(d => {
                    const code = `${d}-${h}`;
                    const isSelected = prefs.includes(code);
                    const bg = isSelected ? 'cell-selected' : '';
                    html += `<td class="${bg}">${isSelected ? '‚úì' : ''}</td>`;
                });
                html += `</tr>`;
            }
            tbody.innerHTML = html;
            document.getElementById('modalCalendarioSocio').style.display = 'flex';
        }

        window.confirmarHorario = async (uid) => {
            if(!confirm("¬øConfirmar que este horario es definitivo? El usuario ver√° la confirmaci√≥n en su perfil.")) return;
            try {
                await updateDoc(doc(db, "usuarios", uid), { horario_confirmado: true });
                alert("‚úÖ Horario confirmado.");
                cerrarModales();
                cargarTodo(); // Recargar tablas
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- UTILIDADES ---
        window.cerrarModales = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }
        window.borrarUsuario = async (uid) => {
            if(confirm("¬øEliminar usuario?")) { await deleteDoc(doc(db, "usuarios", uid)); cargarTodo(); }
        };

        // --- MODAL CREDITOS (ANTIGUO) ---
        window.abrirModalCreditos = (uid) => {
            const u = allUsersGlobal.find(x => x.id === uid);
            if(!u) return;
            document.getElementById('modalUserNombre').innerText = u.nombre || 'Usuario';
            const div = document.getElementById('creditEditors');
            div.innerHTML = "";
            const tipos = ['fuerza', 'pilates', 'personal', 'nutri'];
            let c = u.creditos_detalle || {};
            if(typeof u.creditos === 'number' && !c.fuerza) c.fuerza = u.creditos;

            tipos.forEach(t => {
                div.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="text-transform:uppercase;">${t}</span>
                    <div>
                        <button class="btn-mini" onclick="cambiarSaldo('${uid}','${t}',-1)">-</button>
                        <span style="margin:0 10px; font-weight:bold;">${c[t]||0}</span>
                        <button class="btn-mini" onclick="cambiarSaldo('${uid}','${t}',1)">+</button>
                    </div>
                </div>`;
            });
            document.getElementById('modalCreditos').style.display = 'flex';
        };

        window.cambiarSaldo = async (uid, tipo, delta) => {
            const ref = doc(db, "usuarios", uid);
            // Nota: Para hacerlo bien en tiempo real, deber√≠amos leer el doc actual. 
            // Aqu√≠ usamos el dato en memoria por rapidez, pero en producci√≥n mejor getDoc antes.
            const u = allUsersGlobal.find(x => x.id === uid);
            let c = u.creditos_detalle || {};
            if(typeof u.creditos === 'number' && !c.fuerza) c.fuerza = u.creditos;
            
            c[tipo] = (c[tipo] || 0) + delta;
            if(c[tipo] < 0) c[tipo] = 0;

            await updateDoc(ref, { creditos_detalle: c, creditos: c.fuerza });
            // Actualizamos en local visualmente y recargamos silenciosamente
            u.creditos_detalle = c; 
            abrirModalCreditos(uid); // Refrescar modal
            cargarUsuarios(); // Refrescar tabla fondo
        };

        // --- CLASES Y CALENDARIO ---
        window.crearClase = async () => {
            const nom = document.getElementById('nombreClase').value;
            const fecha = document.getElementById('fechaClase').value;
            const hora = document.getElementById('horaClase').value;
            if(!nom || !fecha || !hora) return alert("Faltan datos");
            await addDoc(collection(db, "clases"), {
                nombre: nom, fecha, hora, plazas_totales: 6, apuntados: [], timestamp: new Date(fecha+'T'+hora).getTime()
            });
            alert("Clase creada"); cargarCalendario();
        };

        window.cargarCalendario = async () => {
            const div = document.getElementById('calendarioContainer');
            div.innerHTML = "Cargando...";
            const q = query(collection(db, "clases"), orderBy("timestamp", "asc"));
            const snap = await getDocs(q);
            if(snap.empty) { div.innerHTML = "No hay clases."; return; }
            let html = "";
            snap.forEach(d => {
                const c = d.data();
                const ocupados = c.apuntados ? c.apuntados.length : 0;
                html += `<div style="background:#222; padding:10px; margin-bottom:5px; border-left:3px solid #ff007f;">
                    <strong>${c.fecha} ${c.hora}</strong> - ${c.nombre} (${ocupados}/${c.plazas_totales})
                    <button class="btn-del" onclick="borrarClase('${d.id}')" style="float:right;">üóëÔ∏è</button>
                </div>`;
            });
            div.innerHTML = html;
        };
        window.borrarClase = async(id) => { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db,"clases",id)); cargarCalendario(); } }

        // --- LEADS ---
        window.cargarInteresados = async () => {
            const tbody = document.getElementById('tablaLeads');
            if(!tbody) return;
            const q = query(collection(db, "interesados"), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(d => {
                const l = d.data();
                html += `<tr><td>${new Date(l.fecha.seconds*1000).toLocaleDateString()}</td><td>${l.nombre}</td><td>${l.telefono||'-'}</td><td><button class="btn-del" onclick="borrarLead('${d.id}')">üóëÔ∏è</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }
        window.borrarLead = async(id) => { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db,"interesados",id)); cargarInteresados(); } }

        // INICIALIZAR
        window.onload = () => { cargarTodo(); };
    </script>
</body>
</html>