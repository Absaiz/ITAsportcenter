<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITA | ADMIN PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script>
        const v = Date.now();
        function cargarCSS(archivo) { var link = document.createElement("link"); link.rel = "stylesheet"; link.href = archivo + "?v=" + v; document.head.appendChild(link); }
        function cargarJS(archivo) { var script = document.createElement('script'); script.type = 'module'; script.src = archivo + '?v=' + v; document.head.appendChild(script); }
        cargarCSS('style.css'); cargarJS('layout.js'); cargarJS('user-logic.js');
    </script>

    <style>
        body { background-color: #121212; color: white; font-family: 'Montserrat', sans-serif; }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        
        .admin-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { background: #222; color: #888; border: 1px solid #333; padding: 12px 30px; cursor: pointer; border-radius: 30px; font-family: 'Oswald'; text-transform: uppercase; transition: 0.3s; }
        .tab-btn.active { background: #ff007f; color: white; border-color: #ff007f; }

        .view-section { display: none; grid-template-columns: 1fr; gap: 40px; }
        .view-section.active { display: grid; }
        
        .panel-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 25px; }
        .panel-title { font-family: 'Oswald'; color: #ff007f; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* TABLA MAPA DE CALOR */
        .heat-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem; }
        .heat-table th { color: #ff007f; padding: 10px; border-bottom: 2px solid #333; font-family: 'Oswald'; }
        .heat-table td { padding: 15px; border: 1px solid #333; color: #666; font-weight: bold; }
        
        /* Celdas con actividad */
        .heat-low { background: rgba(255, 0, 127, 0.1); color: white !important; }
        .heat-med { background: rgba(255, 0, 127, 0.4); color: white !important; }
        .heat-high { background: rgba(255, 0, 127, 0.8); color: white !important; }

        /* Resto de estilos del admin anterior... */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn-create { width: 100%; padding: 12px; background: #ff007f; color: white; border: none; font-weight: bold; cursor: pointer; }
        .user-table { width: 100%; border-collapse: collapse; } .user-table th, .user-table td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1 style="text-align: center; font-size: 3rem; margin: 0 0 30px 0;">ADMINISTRACIN</h1>

        <div class="admin-tabs">
            <button class="tab-btn" onclick="cambiarPestana('clases')"> CLASES</button>
            <button class="tab-btn active" onclick="cambiarPestana('demanda')"> MAPA DE DEMANDA</button>
            <button class="tab-btn" onclick="cambiarPestana('socios')"> SOCIOS</button>
        </div>

        <div id="vista-clases" class="view-section">
            <div class="panel-card">
                <div class="panel-title"> NUEVA CLASE</div>
                <div class="form-grid">
                    <input type="text" id="nombreClase" placeholder="Nombre">
                    <select id="tipoClase"><option value="fuerza">Fuerza</option><option value="pilates">Pilates</option></select>
                    <input type="date" id="fechaClase"><input type="time" id="horaClase"><input type="number" id="plazasClase" value="6">
                </div>
                <button class="btn-create" onclick="crearClase()">PROGRAMAR CLASE</button>
            </div>
            <div class="panel-card"><div id="calendarioContainer">Cargando...</div></div>
        </div>

        <div id="vista-demanda" class="view-section active">
            <div class="panel-card" style="border-color: #ff007f;">
                <div class="panel-title">
                    <span> PREFERENCIAS DE LOS SOCIOS</span>
                    <button class="btn-mini" onclick="cargarMapaCalor()" style="background:#333; color:white; border:none; padding:5px 10px; cursor:pointer;"> Actualizar</button>
                </div>
                <p style="color:#aaa; margin-bottom:20px;">Este cuadro muestra cu谩ntas personas quieren entrenar en cada franja horaria.</p>
                
                <table class="heat-table">
                    <thead>
                        <tr><th>HORA</th><th>LUN</th><th>MAR</th><th>MI</th><th>JUE</th><th>VIE</th><th>SB</th></tr>
                    </thead>
                    <tbody id="tablaCalor">
                        <tr><td colspan="7">Calculando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="vista-socios" class="view-section">
            <div class="panel-card">
                <div class="panel-title"> LISTADO DE SOCIOS</div>
                <table class="user-table"><tbody id="tablaUsuarios"></tbody></table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // --- SISTEMA DE PESTAAS ---
        window.cambiarPestana = (p) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`vista-${p}`).classList.add('active');
            // Hack visual para botones
            const btns = document.querySelectorAll('.tab-btn');
            if(p==='clases') btns[0].classList.add('active');
            if(p==='demanda') btns[1].classList.add('active');
            if(p==='socios') btns[2].classList.add('active');
        }

        // --- LGICA DEL MAPA DE CALOR (HEATMAP) ---
        window.cargarMapaCalor = async () => {
            const tbody = document.getElementById('tablaCalor');
            tbody.innerHTML = '<tr><td colspan="7">Leyendo preferencias de todos los usuarios...</td></tr>';
            
            try {
                // 1. Obtener todos los usuarios
                const snap = await getDocs(collection(db, "usuarios"));
                
                // 2. Inicializar contadores a 0
                const dias = ['L', 'Ma', 'X', 'J', 'V', 'S'];
                const franjas = ['M', 'MD', 'T']; // Ma帽ana, Mediod铆a, Tarde
                let datos = {}; 
                
                // Estructura: datos['L-M'] = 0, datos['L-T'] = 0...
                dias.forEach(d => { franjas.forEach(f => { datos[`${d}-${f}`] = 0; }); });

                // 3. Recorrer usuarios y sumar votos
                snap.forEach(doc => {
                    const u = doc.data();
                    if(u.preferencias_horario && Array.isArray(u.preferencias_horario)) {
                        u.preferencias_horario.forEach(voto => {
                            if(datos[voto] !== undefined) datos[voto]++;
                        });
                    }
                });

                // 4. Pintar Tabla
                let html = "";
                const etiquetas = { 'M': 'MAANA<br>(07-12h)', 'MD': 'MEDIODA<br>(12-16h)', 'T': 'TARDE<br>(16-21h)' };

                franjas.forEach(f => {
                    html += `<tr>`;
                    html += `<td style="color:white; background:#222;">${etiquetas[f]}</td>`;
                    
                    dias.forEach(d => {
                        const count = datos[`${d}-${f}`];
                        let clase = "";
                        if(count > 0) clase = "heat-low";
                        if(count > 5) clase = "heat-med";
                        if(count > 10) clase = "heat-high";
                        
                        // Si es S谩bado Tarde, ponemos gui贸n (cerrado)
                        if(d === 'S' && f === 'T') html += `<td style="background:#111;">-</td>`;
                        else html += `<td class="${clase}">${count > 0 ? count : ''}</td>`;
                    });
                    html += `</tr>`;
                });
                tbody.innerHTML = html;

            } catch(e) { console.error(e); tbody.innerHTML = "Error cargando datos."; }
        };
        

        // --- FUNCIONES ANTIGUAS (SOCIOS/CLASES) ---
        window.crearClase = async () => { /* ... Tu c贸digo de crear clase ... */ }
        window.cargarCalendario = async () => { /* ... Tu c贸digo de cargar calendario ... */ }
        window.cargarUsuarios = async () => { /* ... Tu c贸digo de cargar usuarios ... */ }
        
        // Inicializar
        window.onload = () => { cargarMapaCalor(); };
    </script>
</body>
</html>