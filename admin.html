<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ITA | ADMIN PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script>
        const v = Date.now();
        function cargarCSS(a) { var l = document.createElement("link"); l.rel = "stylesheet"; l.href = a + "?v=" + v; document.head.appendChild(l); }
        function cargarJS(a) { var s = document.createElement('script'); s.type = 'module'; s.src = a + "?v=" + v; document.head.appendChild(s); }
        cargarCSS('style.css'); cargarJS('layout.js'); cargarJS('user-logic.js');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #121212; color: white; font-family: 'Montserrat', sans-serif; }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        
        /* TABS */
        .admin-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { background: #222; color: #888; border: 1px solid #333; padding: 10px 25px; cursor: pointer; border-radius: 30px; font-family: 'Oswald'; text-transform: uppercase; transition: 0.3s; }
        .tab-btn.active { background: #ff007f; color: white; border-color: #ff007f; box-shadow: 0 0 10px rgba(255,0,127,0.3); }

        .view-section { display: none; grid-template-columns: 1fr; gap: 30px; }
        .view-section.active { display: grid; }

        /* PANELES */
        .panel-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 20px; }
        .panel-title { font-family: 'Oswald'; color: #ff007f; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* HEATMAP */
        .heat-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem; }
        .heat-table th { color: #ff007f; padding: 8px; border-bottom: 1px solid #444; font-family: 'Oswald'; }
        .heat-table td { padding: 8px; border: 1px solid #333; color: #555; cursor: pointer; transition: 0.2s; }
        .heat-table td:hover { border: 1px solid white; }
        .h-low { background: rgba(255, 0, 127, 0.1); color: white !important; font-weight: bold; }
        .h-med { background: rgba(255, 0, 127, 0.4); color: white !important; font-weight: bold; }
        .h-high { background: rgba(255, 0, 127, 0.8); color: white !important; font-weight: bold; }

        /* TABLAS (SOCIOS Y RADAR) */
        .user-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .user-table th, .user-table td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        .btn-mini { padding: 5px 10px; border-radius: 4px; background: #444; color: white; border: none; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
        .btn-mini:hover { background: #ff007f; }
        .btn-del { background: transparent; border: 1px solid #ff4444; color: #ff4444; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        
        /* FORMULARIO */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; }
        .btn-create { width: 100%; padding: 10px; background: #ff007f; border: none; color: white; font-weight: bold; cursor: pointer; }
        
        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border: 1px solid #ff007f; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        /* CALENDARIO SOCIO */
        .socio-calendar-table { width: 100%; text-align: center; font-size: 0.8rem; }
        .socio-calendar-table th { color: #ff007f; font-family:'Oswald'; }
        .socio-calendar-table td { padding: 4px; border: 1px solid #333; }
        .cell-selected { background-color: #ff007f; color: white; }
        
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-pending { background: #444; color: #aaa; }
        .badge-confirmed { background: #25D366; color: black; }

        /* ITEM CLASE EN CALENDARIO ADMIN */
        .class-item-admin {
            background:#222; padding:10px; margin-bottom:5px; border-left:3px solid #ff007f; cursor:pointer; transition:0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .class-item-admin:hover { background: #333; }

        .chart-controls { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chart-controls::-webkit-scrollbar { height: 4px; }
        .chart-controls::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1 style="text-align: center; margin-bottom: 30px;">ADMIN PANEL</h1>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="cambiarPestana('demanda')">üìä MAPA CALOR</button>
            <button class="tab-btn" onclick="cambiarPestana('clases')">üìÖ CLASES</button>
            <button class="tab-btn" onclick="cambiarPestana('socios')">üë• SOCIOS</button>
        </div>

        <div id="vista-demanda" class="view-section active">
            <div class="panel-card" style="border-color: #ff007f;">
                <div class="panel-title">
                    <span>üî• PREFERENCIAS (Clic en n¬∫ para detalles)</span>
                    <button class="btn-mini" onclick="cargarTodo()">Actualizar</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="heat-table">
                        <thead><tr><th>HORA</th><th>LUN</th><th>MAR</th><th>MI√â</th><th>JUE</th><th>VIE</th><th>S√ÅB</th></tr></thead>
                        <tbody id="tablaCalor"><tr><td colspan="7">Cargando datos...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vista-clases" class="view-section">
            <div class="panel-card">
                <div class="panel-title">NUEVA CLASE</div>
                <div class="form-grid">
                    <input type="text" id="nombreClase" placeholder="Nombre">
                    <select id="tipoClase"><option value="fuerza">Fuerza</option><option value="pilates">Pilates</option></select>
                    <input type="date" id="fechaClase">
                    <input type="time" id="horaClase">
                    <input type="number" id="plazasClase" value="6">
                </div>
                <button class="btn-create" onclick="crearClase()">CREAR CLASE</button>
            </div>
            <div class="panel-card">
                <div class="panel-title">CALENDARIO (Clic para gestionar) <button class="btn-mini" onclick="cargarCalendario()">Refrescar</button></div>
                <div id="calendarioContainer">Cargando...</div>
            </div>
        </div>

        <div id="vista-socios" class="view-section">
            
            <div class="panel-card" style="border: 1px solid #ff4444; background: rgba(255, 68, 68, 0.05); margin-bottom: 30px;">
                <div class="panel-title" style="color: #ff4444; border-bottom-color: #ff4444;">
                    üö® RADAR DE CLIENTES SIN SALDO
                </div>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th style="color:#ff4444">Nombre</th>
                            <th style="color:#ff4444">Alarma</th>
                            <th style="color:#ff4444">WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody id="radarBody">
                        <tr><td colspan="3">Cargando radar...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="panel-card">
                <div class="panel-title">LISTA DE SOCIOS <button class="btn-mini" onclick="cargarTodo()">Refrescar</button></div>
                <table class="user-table">
                    <thead><tr><th>Usuario</th><th>Estado Horario</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="tablaUsuarios"></tbody>
                </table>
            </div>
            <div class="panel-card mt-4">
                <div class="panel-title">LISTA PREINSCRITOS<button class="btn-mini" onclick="cargarInteresados()">Refrescar</button></div>
                <table class="user-table"><tbody id="tablaLeads"></tbody></table>
            </div>
        </div>
    </div>

    <div id="modalCreditos" class="modal-overlay">
        <div class="modal-content" style="max-width:400px;">
            <h3 id="modalUserNombre">Usuario</h3>
            <div id="creditEditors"></div>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModales()">CERRAR</button>
        </div>
    </div>

    <div id="modalDetalleClase" class="modal-overlay">
        <div class="modal-content">
            <h3 id="detalleTitulo" style="color:#ff007f; font-family:'Oswald'; margin-bottom:5px;">Clase</h3>
            <p id="detalleInfo" style="color:#aaa; font-size:0.9rem; margin-bottom:20px;"></p>
            <div style="background:#222; padding:15px; border-radius:5px; margin-bottom:20px;">
                <h5 style="color:white; margin-top:0;">üë• Asistentes:</h5>
                <ul id="listaAsistentes" style="list-style:none; padding:0; margin:0; color:#ccc;"></ul>
            </div>
            <div style="background:#111; padding:15px; border:1px dashed #555; border-radius:5px;">
                <h5 style="color:#ff007f; margin-top:0;">‚ûï A√±adir Alumno (Admin)</h5>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="selectUsuarioAdd" style="flex:1; padding:8px; background:#222; color:white; border:1px solid #444;"></select>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="color:#aaa; font-size:0.9rem; display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="checkRecurrenteAdd" style="width:18px; height:18px; accent-color:#ff007f;">
                        <span>üîÅ Apuntar 8 semanas (si tiene saldo)</span>
                    </label>
                </div>
                <button class="btn-create" id="btnAddUserClass" style="font-size:0.9rem;">INSCRIBIR AHORA</button>
            </div>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModales()">CERRAR</button>
        </div>
    </div>

    <div id="modalPerfilCompleto" class="modal-overlay">
        <div class="modal-content" style="max-width:700px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:15px;">
                <div>
                    <h2 id="perfilNombre" style="color:white; margin:0; font-family:'Oswald';">Usuario</h2>
                    <p id="perfilEmail" style="color:#888; margin:0; font-size:0.9rem;">email@test.com</p>
                </div>
                <a id="btnPerfilWA" href="#" target="_blank" class="btn-mini" style="background:#25D366; text-decoration:none; font-size:1.2rem; display:none;">
                    <i class="bi bi-whatsapp"></i>
                </a>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div style="background:#222; padding:15px; border-radius:10px;">
                    <h5 style="color:#ff007f; margin-top:0;">üìà Evoluci√≥n</h5>
                    <div class="chart-controls">
                        <button class="btn-mini" onclick="updateAdminChart('peso')">Peso</button>
                        <button class="btn-mini" onclick="updateAdminChart('biceps')">B√≠ceps</button>
                        <button class="btn-mini" onclick="updateAdminChart('cintura')">Cintura</button>
                    </div>
                    <canvas id="adminChart" style="max-height:200px;"></canvas>
                </div>
                <div style="background:#222; padding:15px; border-radius:10px;">
                    <h5 style="color:#ff007f; margin-top:0;">üìù Registrar Medidas</h5>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:5px;">
                        <input type="date" id="adminInputFecha" style="grid-column: span 2;">
                        <input type="number" id="adminInputPeso" placeholder="Peso (kg)">
                        <input type="number" id="adminInputAltura" placeholder="Altura">
                        <input type="number" id="adminInputBiceps" placeholder="B√≠ceps">
                        <input type="number" id="adminInputCintura" placeholder="Cintura">
                    </div>
                    <button class="btn-create" onclick="adminGuardarMedidas()">GUARDAR DATOS</button>
                </div>
            </div>
            <button class="btn-create" style="background:#444;" onclick="cerrarModales()">CERRAR FICHA</button>
        </div>
    </div>

    <div id="modalQuien" class="modal-overlay">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <h3 style="color:#ff007f; font-family:'Oswald';">INTERESADOS</h3>
            <h5 id="modalQuienTitulo" style="color:#aaa; margin-bottom:20px;"></h5>
            <ul id="listaInteresados" style="list-style:none; padding:0; text-align:left; border:1px solid #333; padding:10px; background:#222;"></ul>
            <button class="btn-create" style="background:#444; margin-top:20px;" onclick="cerrarModales()">CERRAR</button>
        </div>
    </div>

    <div id="modalCalendarioSocio" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="calSocioNombre" style="color:white; font-family:'Oswald'; margin:0;"></h3>
                <span id="calSocioStatus"></span>
            </div>
            <p style="color:#aaa; font-size:0.9rem;">Preferencias:</p>
            <div style="max-height:300px; overflow-y:auto; margin-bottom:20px;">
                <table class="socio-calendar-table">
                    <thead><tr><th>H</th><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th></tr></thead>
                    <tbody id="calSocioBody"></tbody>
                </table>
            </div>
            <div style="background:#222; padding:15px; border-radius:5px; margin-bottom:15px; border:1px dashed #555;">
                <label style="font-size:0.8rem; color:#aaa; display:block; margin-bottom:5px;">TIPO DE CLASES:</label>
                <select id="selectTipoConfirmacion" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #444;">
                    <option value="fuerza">Fuerza</option>
                    <option value="pilates">Pilates</option>
                </select>
                <small style="color:#666; font-size:0.75rem;">Se crear√°n clases para 2 meses. Si el usuario se queda sin saldo, la clase se crea igual pero no se le apunta.</small>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-create" style="background:#444;" onclick="cerrarModales()">CANCELAR</button>
                <button id="btnConfirmarHorario" class="btn-create" style="background:#25D366; color:black;">‚úÖ CONFIRMAR Y GENERAR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, orderBy, arrayRemove, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        let allUsersGlobal = []; 
        let currentAdminUser = null; 
        let currentAdminChart = null; 
        let currentAdminMedidas = []; 

        window.cambiarPestana = (p) => {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`vista-${p}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(p==='demanda') btns[0].classList.add('active');
            if(p==='clases') btns[1].classList.add('active');
            if(p==='socios') btns[2].classList.add('active');
        }

        window.cargarTodo = async () => {
            await cargarUsuarios();
            cargarMapaCalor();
            cargarCalendario();
            cargarInteresados();
        }

        // --- 1. USUARIOS Y RADAR ---
        window.cargarUsuarios = async () => {
            const tbody = document.getElementById('tablaUsuarios');
            if(tbody) tbody.innerHTML = '<tr><td>Cargando...</td></tr>';
            try {
                const snap = await getDocs(collection(db, "usuarios"));
                allUsersGlobal = [];
                let html = "";
                snap.forEach(d => {
                    const u = d.data(); u.id = d.id; allUsersGlobal.push(u);
                    let estadoHtml = u.horario_confirmado ? `<span class="status-badge badge-confirmed">Confirmado</span>` : `<span class="status-badge badge-pending">Pendiente</span>`;
                    html += `<tr>
                        <td><strong>${u.nombre||'Socio'}</strong><br><small style="color:#888">${u.email}</small></td>
                        <td>${estadoHtml}</td>
                        <td>
                            <button class="btn-mini" onclick="abrirModalCreditos('${u.id}')" title="Cr√©ditos">üí∞</button>
                            <button class="btn-mini" style="background:#54a0ff;" onclick="verCalendarioSocio('${u.id}')" title="Horario">üìÖ</button>
                            <button class="btn-mini" style="background:#e056fd;" onclick="verPerfilSocio('${u.id}')" title="Expediente Completo">üë§</button>
                            <button class="btn-del" onclick="borrarUsuario('${u.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                if(tbody) tbody.innerHTML = html;
                
                // --- CARGAR RADAR EN FORMATO LISTA ---
                cargarRadar();

            } catch(e) { console.error(e); }
        };

        window.cargarRadar = () => {
            const tbody = document.getElementById('radarBody');
            if(!tbody) return;
            tbody.innerHTML = "";

            // Filtro: 0 Cr√©ditos de Fuerza Y 0 Cr√©ditos de Pilates
            const enPeligro = allUsersGlobal.filter(u => {
                let c = u.creditos_detalle || {};
                let fuerza = c.fuerza !== undefined ? c.fuerza : (typeof u.creditos === 'number' ? u.creditos : 0);
                let pilates = c.pilates || 0;
                return (fuerza <= 0 && pilates <= 0);
            });

            if(enPeligro.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#888;'>‚úÖ Todo en orden. Todos los clientes tienen saldo.</td></tr>";
                return;
            }

            let html = "";
            enPeligro.forEach(u => {
                let tlf = u.telefono ? u.telefono.replace(/\D/g,'') : '';
                let msg = `Hola ${u.nombre || ''}, he visto que te has quedado sin bonos en ITA. ¬øTe renuevo para mantener la plaza?`;
                let link = tlf ? `https://wa.me/${tlf}?text=${encodeURIComponent(msg)}` : '#';
                
                html += `<tr>
                    <td><strong>${u.nombre || 'Socio'}</strong><br><small style="color:#888">${u.email}</small></td>
                    <td><span style="color:#ff4444; font-weight:bold;">‚ö†Ô∏è SALDO 0</span></td>
                    <td>
                        ${tlf ? 
                            `<a href="${link}" target="_blank" style="text-decoration:none; color:#25D366; font-weight:bold; font-size:0.9rem;">
                                <i class="bi bi-whatsapp"></i> AVISAR
                            </a>` 
                            : '<span style="color:#666; font-size:0.8rem;">Sin Tlf</span>'
                        }
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- 1.5 PERFIL DE SOCIO ---
        window.verPerfilSocio = async (uid) => {
            const u = allUsersGlobal.find(x => x.id === uid);
            if(!u) return;
            currentAdminUser = u;

            document.getElementById('perfilNombre').innerText = u.nombre || 'Socio';
            document.getElementById('perfilEmail').innerText = u.email;
            
            const btnWa = document.getElementById('btnPerfilWA');
            if(u.telefono) {
                btnWa.style.display = 'block';
                btnWa.href = `https://wa.me/${u.telefono.replace(/\D/g,'')}`;
            } else { btnWa.style.display = 'none'; }

            document.getElementById('adminInputFecha').valueAsDate = new Date();
            await cargarMedidasAdmin(uid);
            document.getElementById('modalPerfilCompleto').style.display = 'flex';
        }

        async function cargarMedidasAdmin(uid) {
            const q = query(collection(db, "medidas"), where("userId", "==", uid), orderBy("timestamp", "asc"));
            const s = await getDocs(q);
            currentAdminMedidas = [];
            s.forEach(d => currentAdminMedidas.push(d.data()));
            renderAdminChart('peso'); 
        }

        window.renderAdminChart = (tipo) => {
            const ctx = document.getElementById('adminChart').getContext('2d');
            if(currentAdminChart) currentAdminChart.destroy();
            const labels = currentAdminMedidas.map(m => new Date(m.timestamp).toLocaleDateString());
            const data = currentAdminMedidas.map(m => m[tipo] || 0);
            currentAdminChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: tipo.toUpperCase(), data: data, borderColor: '#ff007f', backgroundColor: 'rgba(255, 0, 127, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, plugins: { legend: { display:false } }, scales: { y:{grid:{color:'#333'}}, x:{grid:{color:'#333'}} } }
            });
        }
        window.updateAdminChart = (t) => renderAdminChart(t);

        window.adminGuardarMedidas = async () => {
            if(!currentAdminUser) return;
            const fecha = document.getElementById('adminInputFecha').value;
            if(!fecha) return alert("Pon fecha");
            const datos = {
                userId: currentAdminUser.id, fecha: fecha, timestamp: new Date(fecha).getTime(),
                peso: parseFloat(document.getElementById('adminInputPeso').value) || 0,
                altura: parseFloat(document.getElementById('adminInputAltura').value) || 0,
                biceps: parseFloat(document.getElementById('adminInputBiceps').value) || 0,
                cintura: parseFloat(document.getElementById('adminInputCintura').value) || 0
            };
            try {
                await addDoc(collection(db, "medidas"), datos);
                alert("Medida guardada."); document.getElementById('adminInputPeso').value = ""; await cargarMedidasAdmin(currentAdminUser.id);
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- 2. GESTI√ìN DE CLASES ---
        window.cargarCalendario = async () => {
            const div = document.getElementById('calendarioContainer'); div.innerHTML = "Cargando...";
            const q = query(collection(db, "clases"), orderBy("timestamp", "asc"));
            const snap = await getDocs(q);
            if(snap.empty) { div.innerHTML = "No hay clases."; return; }
            let html = "";
            snap.forEach(d => {
                const c = d.data();
                const ocupados = c.apuntados ? c.apuntados.length : 0;
                html += `<div class="class-item-admin" onclick="verDetalleClase('${d.id}')">
                    <div><strong>${c.fecha} ${c.hora}</strong> - ${c.nombre} <span style="color:${ocupados>=c.plazas_totales?'red':'#25D366'}">(${ocupados}/${c.plazas_totales})</span></div>
                    <button class="btn-del" onclick="event.stopPropagation(); borrarClase('${d.id}')" title="Borrar Clase">üóëÔ∏è</button>
                </div>`;
            });
            div.innerHTML = html;
        };

        window.verDetalleClase = async (idClase) => {
            const claseRef = doc(db, "clases", idClase);
            const claseSnap = await getDoc(claseRef);
            if(!claseSnap.exists()) return;
            const c = claseSnap.data();
            document.getElementById('detalleTitulo').innerText = `${c.nombre}`;
            document.getElementById('detalleInfo').innerText = `${c.fecha} a las ${c.hora} (${c.tipo || 'General'})`;
            const lista = document.getElementById('listaAsistentes');
            lista.innerHTML = "";
            if(c.apuntados && c.apuntados.length > 0) {
                c.apuntados.forEach(uid => {
                    const u = allUsersGlobal.find(user => user.id === uid);
                    const nombre = u ? u.nombre : "Desconocido";
                    lista.innerHTML += `<li style="padding:5px; border-bottom:1px solid #333; display:flex; justify-content:space-between;"><span>üë§ ${nombre}</span><button class="btn-del" style="width:20px; height:20px;" onclick="expulsarDeClase('${idClase}', '${uid}')">x</button></li>`;
                });
            } else { lista.innerHTML = "<li>Sin inscritos</li>"; }
            const select = document.getElementById('selectUsuarioAdd');
            select.innerHTML = "<option value=''>Seleccionar Alumno...</option>";
            allUsersGlobal.forEach(u => { select.innerHTML += `<option value="${u.id}">${u.nombre || u.email}</option>`; });
            document.getElementById('btnAddUserClass').onclick = () => adminInscribirUsuario(idClase, c);
            document.getElementById('modalDetalleClase').style.display = 'flex';
        }

        window.adminInscribirUsuario = async (idClase, datosClase) => {
            const uid = document.getElementById('selectUsuarioAdd').value;
            const recurrente = document.getElementById('checkRecurrenteAdd').checked;
            if(!uid) return alert("Selecciona un usuario.");
            const usuario = allUsersGlobal.find(u => u.id === uid);
            const tipo = datosClase.tipo || 'fuerza';
            let creds = usuario.creditos_detalle || {};
            if(typeof usuario.creditos === 'number' && creds.fuerza === undefined) creds.fuerza = usuario.creditos;
            if(!creds[tipo] || creds[tipo] <= 0) return alert(`‚ùå ${usuario.nombre} no tiene cr√©ditos suficientes de ${tipo}.`);
            try {
                creds[tipo]--;
                await updateDoc(doc(db, "usuarios", uid), { creditos_detalle: creds, creditos: creds.fuerza });
                const nuevosApuntados = datosClase.apuntados || [];
                if(!nuevosApuntados.includes(uid)) {
                    nuevosApuntados.push(uid);
                    await updateDoc(doc(db, "clases", idClase), { apuntados: nuevosApuntados });
                }
                alert(`‚úÖ Inscrito en la clase del ${datosClase.fecha}. Saldo restante: ${creds[tipo]}`);
                if(recurrente) await procesarRecurrenciaAdmin(usuario, datosClase, uid, creds, tipo);
                verDetalleClase(idClase); cargarCalendario(); cargarUsuarios();
            } catch(e) { alert("Error: " + e.message); }
        }

        async function procesarRecurrenciaAdmin(usuario, claseOriginal, uid, credsActualizados, tipo) {
            const fechaOriginal = new Date(claseOriginal.fecha + 'T' + claseOriginal.hora);
            const limite = new Date(); limite.setDate(limite.getDate() + 60); 
            let cursor = new Date(fechaOriginal);
            cursor.setDate(cursor.getDate() + 7); 
            let inscritas = 0;
            let saldoLocal = credsActualizados[tipo];
            while(cursor <= limite) {
                if(saldoLocal <= 0) { alert(`‚ö†Ô∏è Saldo agotado tras inscribir ${inscritas} clases extra.`); break; }
                const fechaStr = cursor.toISOString().split('T')[0];
                const q = query(collection(db, "clases"), where("fecha", "==", fechaStr), where("hora", "==", claseOriginal.hora), where("tipo", "==", claseOriginal.tipo));
                const snaps = await getDocs(q);
                let apuntado = false;
                if(snaps.empty) {
                    await addDoc(collection(db, "clases"), {
                        nombre: claseOriginal.nombre, tipo: claseOriginal.tipo,
                        fecha: fechaStr, hora: claseOriginal.hora, plazas_totales: claseOriginal.plazas_totales,
                        apuntados: [uid],
                        timestamp: new Date(`${fechaStr}T${claseOriginal.hora}`).getTime()
                    });
                    apuntado = true;
                } else {
                    snaps.forEach(async (docClase) => {
                        const d = docClase.data();
                        const ap = d.apuntados || [];
                        if(!ap.includes(uid) && ap.length < d.plazas_totales) {
                            ap.push(uid);
                            await updateDoc(doc(db, "clases", docClase.id), { apuntados: ap });
                            apuntado = true;
                        }
                    });
                }
                if(apuntado) { inscritas++; saldoLocal--; }
                cursor.setDate(cursor.getDate() + 7);
            }
            credsActualizados[tipo] = saldoLocal;
            await updateDoc(doc(db, "usuarios", uid), { creditos_detalle: credsActualizados, creditos: credsActualizados.fuerza });
        }

        window.expulsarDeClase = async (cid, uid) => {
            if(!confirm("¬øQuitar usuario?")) return;
            await updateDoc(doc(db, "clases", cid), { apuntados: arrayRemove(uid) });
            verDetalleClase(cid);
        }

        // --- 3. GENERACI√ìN AUTOM√ÅTICA ---
        window.confirmarHorario = async (uid) => {
            const tipoClase = document.getElementById('selectTipoConfirmacion').value;
            const btn = document.getElementById('btnConfirmarHorario');
            const user = allUsersGlobal.find(x => x.id === uid);
            if(!user || !user.preferencias_horario || user.preferencias_horario.length === 0) return alert("Sin preferencias.");
            if(!confirm(`‚ö†Ô∏è ¬øGenerar horario para ${user.nombre}?`)) return;
            btn.innerText = "‚è≥ Procesando..."; btn.disabled = true;
            try {
                await updateDoc(doc(db, "usuarios", uid), { horario_confirmado: true });
                const diasMapa = {'L':1, 'Ma':2, 'X':3, 'J':4, 'V':5, 'S':6};
                const hoy = new Date();
                const limite = new Date(); limite.setDate(hoy.getDate() + 60);
                const slots = [];
                user.preferencias_horario.forEach(pref => {
                    const [d, h] = pref.split('-');
                    const horaStr = parseInt(h) < 10 ? `0${h}:00` : `${h}:00`;
                    if(diasMapa[d]) slots.push({ dia: diasMapa[d], hora: horaStr });
                });
                let creds = user.creditos_detalle || {};
                if(typeof user.creditos === 'number' && creds.fuerza === undefined) creds.fuerza = user.creditos;
                let saldoDisponible = creds[tipoClase] || 0;
                let cursor = new Date(hoy); cursor.setDate(cursor.getDate() + 1);
                let clasesCreadas = 0; let inscripciones = 0;
                while(cursor <= limite) {
                    const diaSemana = cursor.getDay();
                    const matches = slots.filter(s => s.dia === diaSemana);
                    for (const slot of matches) {
                        let meterUsuario = false;
                        if(saldoDisponible > 0) { meterUsuario = true; saldoDisponible--; inscripciones++; }
                        const fechaStr = cursor.toISOString().split('T')[0];
                        const q = query(collection(db, "clases"), where("fecha", "==", fechaStr), where("hora", "==", slot.hora), where("tipo", "==", tipoClase));
                        const snaps = await getDocs(q);
                        if(snaps.empty) {
                            await addDoc(collection(db, "clases"), {
                                nombre: (tipoClase==='fuerza'?'Grupo Fuerza':'Grupo Pilates'), tipo: tipoClase,
                                fecha: fechaStr, hora: slot.hora, plazas_totales: 4,
                                apuntados: meterUsuario ? [uid] : [],
                                timestamp: new Date(`${fechaStr}T${slot.hora}`).getTime()
                            });
                            clasesCreadas++;
                        } else {
                            if(meterUsuario) {
                                snaps.forEach(async (docClase) => {
                                    const d = docClase.data(); const ap = d.apuntados || [];
                                    if(!ap.includes(uid) && ap.length < d.plazas_totales) {
                                        ap.push(uid); await updateDoc(doc(db, "clases", docClase.id), { apuntados: ap });
                                    }
                                });
                            }
                        }
                    }
                    cursor.setDate(cursor.getDate() + 1);
                }
                creds[tipoClase] = saldoDisponible;
                await updateDoc(doc(db, "usuarios", uid), { creditos_detalle: creds, creditos: creds.fuerza });
                alert(`‚úÖ HECHO: ${inscripciones} sesiones inscritas.`);
                cerrarModales(); cargarTodo();
            } catch(e) { console.error(e); alert("Error: " + e.message); } 
            finally { btn.innerText = "‚úÖ CONFIRMAR Y GENERAR"; btn.disabled = false; }
        }

        // --- RESTO DE FUNCIONES ---
        window.cargarMapaCalor = () => {
            const tbody = document.getElementById('tablaCalor'); if(!tbody) return;
            let heatMap = {}; const dias = ['L', 'Ma', 'X', 'J', 'V', 'S'];
            for(let h=7; h<=22; h++) { dias.forEach(d => { heatMap[`${d}-${h}`] = []; }); }
            allUsersGlobal.forEach(u => {
                if(u.preferencias_horario) u.preferencias_horario.forEach(v => { if(heatMap[v]) heatMap[v].push(u.nombre||u.email); });
            });
            let html = "";
            for(let h=7; h<=22; h++) {
                let hStr = h<10?`0${h}:00`:`${h}:00`; html+=`<tr><td style="color:#ff007f;font-weight:bold;">${hStr}</td>`;
                dias.forEach(d => {
                    const l = heatMap[`${d}-${h}`]; const val = l.length;
                    let cls="", clk="";
                    if(val>0) { cls=val<=3?"h-low":val<=7?"h-med":"h-high"; clk=`onclick="verQuien('${d}',${h},${JSON.stringify(l).replace(/"/g,'&quot;')})"`; }
                    html+=`<td class="${cls}" ${clk}>${val>0?val:'-'}</td>`;
                }); html+="</tr>";
            }
            tbody.innerHTML = html;
        };

        window.verQuien = (d, h, l) => {
            const diasF = {'L':'Lunes','Ma':'Martes','X':'Mi√©rcoles','J':'Jueves','V':'Viernes','S':'S√°bado'};
            document.getElementById('modalQuienTitulo').innerText = `${diasF[d]} a las ${h}:00`;
            document.getElementById('listaInteresados').innerHTML = l.map(n=>`<li style="padding:5px;border-bottom:1px solid #444;">üë§ ${n}</li>`).join('');
            document.getElementById('modalQuien').style.display='flex';
        }

        window.verCalendarioSocio = (uid) => {
            const u = allUsersGlobal.find(x => x.id === uid); if(!u) return;
            document.getElementById('calSocioNombre').innerText = u.nombre || "Socio";
            document.getElementById('calSocioStatus').innerHTML = u.horario_confirmado ? '<span class="status-badge badge-confirmed">CONFIRMADO</span>' : '<span class="status-badge badge-pending">PENDIENTE</span>';
            document.getElementById('btnConfirmarHorario').onclick = () => confirmarHorario(uid);
            const dias = ['L', 'Ma', 'X', 'J', 'V', 'S']; const prefs = u.preferencias_horario || [];
            let html = "";
            for(let h=7; h<=22; h++) {
                html += `<tr><td>${h}</td>`;
                dias.forEach(d => {
                    html += `<td class="${prefs.includes(`${d}-${h}`)?'cell-selected':''}">${prefs.includes(`${d}-${h}`)?'‚úì':''}</td>`;
                }); html += `</tr>`;
            }
            document.getElementById('calSocioBody').innerHTML = html;
            document.getElementById('modalCalendarioSocio').style.display = 'flex';
        }

        window.cerrarModales = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        window.borrarUsuario = async (uid) => { if(confirm("¬øEliminar?")) { await deleteDoc(doc(db,"usuarios",uid)); cargarTodo(); } };
        window.borrarClase = async(id) => { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db,"clases",id)); cargarCalendario(); } };
        
        window.abrirModalCreditos = (uid) => {
            const u = allUsersGlobal.find(x=>x.id===uid); if(!u)return;
            document.getElementById('modalUserNombre').innerText=u.nombre||'Usuario';
            const div=document.getElementById('creditEditors'); div.innerHTML="";
            const tip=['fuerza','pilates','personal','nutri'];
            let c=u.creditos_detalle||{}; if(typeof u.creditos==='number'&&!c.fuerza)c.fuerza=u.creditos;
            tip.forEach(t=>{ div.innerHTML+=`<div style="display:flex;justify-content:space-between;margin-bottom:10px;"><span style="text-transform:uppercase;">${t}</span><div><button class="btn-mini" onclick="cambiarSaldo('${uid}','${t}',-1)">-</button><span style="margin:0 10px;font-weight:bold;">${c[t]||0}</span><button class="btn-mini" onclick="cambiarSaldo('${uid}','${t}',1)">+</button></div></div>`; });
            document.getElementById('modalCreditos').style.display='flex';
        }
        window.cambiarSaldo=async(uid,t,d)=>{
            const u=allUsersGlobal.find(x=>x.id===uid); let c=u.creditos_detalle||{};
            if(typeof u.creditos==='number'&&!c.fuerza)c.fuerza=u.creditos;
            c[t]=(c[t]||0)+d; if(c[t]<0)c[t]=0;
            await updateDoc(doc(db,"usuarios",uid),{creditos_detalle:c,creditos:c.fuerza});
            u.creditos_detalle=c; abrirModalCreditos(uid); cargarUsuarios();
        }

        window.crearClase = async () => {
            const nom=document.getElementById('nombreClase').value; const fec=document.getElementById('fechaClase').value; const hor=document.getElementById('horaClase').value; const tip=document.getElementById('tipoClase').value;
            if(!nom||!fec||!hor)return alert("Faltan datos");
            await addDoc(collection(db,"clases"),{nombre:nom,tipo:tip,fecha:fec,hora:hor,plazas_totales:6,apuntados:[],timestamp:new Date(fec+'T'+hor).getTime()});
            alert("Creada"); cargarCalendario();
        }

        window.cargarInteresados = async () => {
            const tb = document.getElementById('tablaLeads'); if (!tb) return;
            const s = await getDocs(query(collection(db, "interesados"), orderBy("fecha", "desc")));
            let h = "";
            s.forEach(d => {
                const l = d.data();
                let telDisplay = '-';
                if (l.telefono) {
                    const cleanTel = l.telefono.replace(/\D/g, '');
                    telDisplay = `<a href="https://wa.me/${cleanTel}" target="_blank" style="color:#25D366; text-decoration:none; font-weight:bold;"><i class="bi bi-whatsapp"></i> ${l.telefono}</a>`;
                }
                h += `<tr><td>${new Date(l.fecha.seconds * 1000).toLocaleDateString()}</td><td>${l.nombre}<br><small style="color:#888">${l.email}</small></td><td>${telDisplay}</td><td><button class="btn-del" onclick="borrarLead('${d.id}')">üóëÔ∏è</button></td></tr>`;
            });
            tb.innerHTML = h;
        }
        window.borrarLead=async(id)=>{if(confirm("¬øBorrar?")) {await deleteDoc(doc(db,"interesados",id)); cargarInteresados();}}

        window.onload = () => { cargarTodo(); };
    </script>
</body>
</html>